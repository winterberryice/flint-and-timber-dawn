name: Build Dawn Binaries

on:
  push:
    paths:
      - 'third_party/webgpu/**'
      - 'CMakeLists.txt'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    container: dockcross/manylinux_2_28-x64:latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: >
        dnf install -y mesa-libGL-devel libxcb libxcb-devel libX11-xcb libXcursor-devel libXrandr-devel libXinerama-devel libXi-devel libXext-devel libxkbcommon libxkbcommon-devel libxkbcommon-x11-devel mesa-vulkan-drivers wayland-protocols-devel wayland-devel

    - name: Configure CMake
      run: cmake --preset release

    - name: Build
      run: cmake --build --preset release

    - name: Collect Dawn Artifacts
      run: |
        mkdir -p dawn-artifacts/linux/lib
        mkdir -p dawn-artifacts/linux/include
        # Copy Dawn shared library
        cp build/release/_deps/dawn-build/src/dawn/native/libwebgpu_dawn.so dawn-artifacts/linux/lib/
        # Copy headers (forwarding header)
        cp -r build/release/_deps/dawn-src/include/* dawn-artifacts/linux/include/
        # Copy generated headers (actual implementation)
        cp -r build/release/_deps/dawn-build/gen/include/* dawn-artifacts/linux/include/

    - name: Upload Dawn Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dawn-linux-x64
        path: dawn-artifacts/

  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up MSBuild
      uses: microsoft/setup-msbuild@v1.3

    - name: Configure CMake
      run: cmake -S . -B build/release -G "Visual Studio 17 2022" -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build/release --config Release

    - name: Collect Dawn Artifacts
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path dawn-artifacts/windows/lib
        New-Item -ItemType Directory -Force -Path dawn-artifacts/windows/include
        # Copy Dawn DLL (from Release root directory)
        Copy-Item build/release/_deps/dawn-build/Release/webgpu_dawn.dll dawn-artifacts/windows/lib/
        # Copy Dawn .lib (from native/Release directory)
        Copy-Item build/release/_deps/dawn-build/src/dawn/native/Release/webgpu_dawn.lib dawn-artifacts/windows/lib/
        # Copy headers (forwarding header)
        Copy-Item -Recurse -Force build/release/_deps/dawn-src/include/* dawn-artifacts/windows/include/
        # Copy generated headers (actual implementation) - Force overwrite
        Copy-Item -Recurse -Force build/release/_deps/dawn-build/gen/include/* dawn-artifacts/windows/include/

    - name: Upload Dawn Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dawn-windows-x64
        path: dawn-artifacts/

  build-macos-universal:
    runs-on: macos-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Build for Apple Silicon (ARM64)
      run: |
        cmake -S . -B build/release-arm64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64
        cmake --build build/release-arm64 --config Release

    - name: Build for Intel (x86_64)
      run: |
        cmake -S . -B build/release-x86_64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64
        cmake --build build/release-x86_64 --config Release

    - name: Collect Dawn Artifacts
      run: |
        mkdir -p dawn-artifacts/macos/lib
        mkdir -p dawn-artifacts/macos/include
        # Create universal Dawn library
        lipo -create -output dawn-artifacts/macos/lib/libwebgpu_dawn.dylib \
          build/release-arm64/_deps/dawn-build/src/dawn/native/libwebgpu_dawn.dylib \
          build/release-x86_64/_deps/dawn-build/src/dawn/native/libwebgpu_dawn.dylib
        # Copy headers from arm64 build (both builds have same headers)
        cp -r build/release-arm64/_deps/dawn-src/include/* dawn-artifacts/macos/include/
        cp -r build/release-arm64/_deps/dawn-build/gen/include/* dawn-artifacts/macos/include/

    - name: Upload Dawn Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dawn-macos-universal
        path: dawn-artifacts/

  create-release:
    needs: [build-linux, build-windows, build-macos-universal]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download Linux artifacts
      uses: actions/download-artifact@v4
      with:
        name: dawn-linux-x64
        path: artifacts/linux

    - name: Download Windows artifacts
      uses: actions/download-artifact@v4
      with:
        name: dawn-windows-x64
        path: artifacts/windows

    - name: Download macOS artifacts
      uses: actions/download-artifact@v4
      with:
        name: dawn-macos-universal
        path: artifacts/macos

    - name: Package artifacts
      run: |
        cd artifacts/linux
        tar -czf ../../dawn-linux-x64.tar.gz *
        cd ../windows
        zip -r ../../dawn-windows-x64.zip *
        cd ../macos
        tar -czf ../../dawn-macos-universal.tar.gz *
        cd ../..

    - name: Get Dawn tag
      id: tag
      run: |
        TAG=$(cat third_party/webgpu/dawn/dawn-git-tag.txt | tr -d '[:space:]')
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "Using Dawn tag: $TAG"

    - name: Delete existing release if present
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release delete "${{ steps.tag.outputs.tag }}" --yes || true
        echo "Cleaned up any existing release"

    - name: Create Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create "${{ steps.tag.outputs.tag }}" \
          --title "Dawn WebGPU Binaries - ${{ steps.tag.outputs.tag }}" \
          --notes "Automated build of Dawn WebGPU binaries for Linux, Windows, and macOS.

          **Dawn Version:** \`${{ steps.tag.outputs.tag }}\`
          **Built from commit:** ${{ github.sha }}

          **Platforms:**
          - Linux x64
          - Windows x64
          - macOS Universal (ARM64 + x86_64)

          **Files:**
          - \`dawn-linux-x64.tar.gz\` - Linux binaries and headers
          - \`dawn-windows-x64.zip\` - Windows DLL, LIB, and headers
          - \`dawn-macos-universal.tar.gz\` - macOS universal binaries and headers" \
          dawn-linux-x64.tar.gz \
          dawn-windows-x64.zip \
          dawn-macos-universal.tar.gz
